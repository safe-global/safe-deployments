name: Update Registry

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Safe version with deployment type'
        required: true
        type: choice
        options:
          - v1.3.0-canonical
          - v1.3.0-eip155
          - v1.3.0-both
          - v1.4.1
          - v1.5.0
      chain_id:
        description: 'Chain ID to add (e.g., 12345)'
        required: true
        type: string
  workflow_call:
    inputs:
      version:
        description: 'Safe version with deployment type'
        required: true
        type: string
      chain_id:
        description: 'Chain ID to add (e.g., 12345)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-registry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Update registry
        run: |
          if [ "${{ inputs.version }}" = "v1.3.0-both" ]; then
            echo "Running for both v1.3.0 deployment types..."
            npm run update-registry -- \
              --version "v1.3.0-canonical" \
              --chainId "${{ inputs.chain_id }}" \
              --verbose
            npm run update-registry -- \
              --version "v1.3.0-eip155" \
              --chainId "${{ inputs.chain_id }}" \
              --verbose
          else
            npm run update-registry -- \
              --version "${{ inputs.version }}" \
              --chainId "${{ inputs.chain_id }}" \
              --verbose
          fi

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Add chain ${{ inputs.chain_id }} to ${{ inputs.version }} registry
            
            - Added chain ID ${{ inputs.chain_id }} to all contracts in version ${{ inputs.version }}
          title: |
            Add chain ${{ inputs.chain_id }} to ${{ inputs.version == 'v1.3.0-both' && 'v1.3.0 (canonical + eip155)' || inputs.version }} registry
          body: |
            This PR adds chain ID `${{ inputs.chain_id }}` to the registry for version `${{ inputs.version }}`.
            
            **Changes:**
            ${{ inputs.version == 'v1.3.0-both' && format('- Added chain ID `{0}` to all contract JSON files in `src/assets/v1.3.0/` for both canonical and eip155 deployment types', inputs.chain_id) || format('- Added chain ID `{0}` to all contract JSON files in `src/assets/{1}/`', inputs.chain_id, inputs.version) }}
            
            **Generated by:** GitHub Actions workflow
            
            Please review the changes and verify that the chain ID and version are correct.
          branch: update-registry-${{ github.run_id }}-${{ inputs.chain_id }}
          delete-branch: true

