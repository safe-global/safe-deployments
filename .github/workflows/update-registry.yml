name: Update Registry

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Safe version (e.g., v1.5.0)'
        required: true
        type: string
      chain_id:
        description: 'Chain ID to add (e.g., 12345)'
        required: true
        type: string
      deployment_type:
        description: 'Deployment type (canonical, eip155, zksync)'
        required: false
        type: string
        default: 'canonical'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-registry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Update registry
        run: |
          npm run update-registry -- \
            --version "${{ inputs.version }}" \
            --chainId "${{ inputs.chain_id }}" \
            --deploymentType "${{ inputs.deployment_type }}" \
            --verbose

      - name: Format JSON files
        run: npm run lint:fix:json

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Add chain ${{ inputs.chain_id }} to ${{ inputs.version }} registry
            
            - Added chain ID ${{ inputs.chain_id }} to all contracts in version ${{ inputs.version }}
            - Deployment type: ${{ inputs.deployment_type }}
          title: |
            Add chain ${{ inputs.chain_id }} to ${{ inputs.version }} registry
          body: |
            This PR adds chain ID `${{ inputs.chain_id }}` to the registry for version `${{ inputs.version }}`.
            
            **Changes:**
            - Added chain ID `${{ inputs.chain_id }}` to all contract JSON files in `src/assets/${{ inputs.version }}/`
            - Deployment type: `${{ inputs.deployment_type }}`
            
            **Generated by:** GitHub Actions workflow
            
            Please review the changes and verify that the chain ID and deployment type are correct.
          branch: update-registry-${{ inputs.version }}-${{ inputs.chain_id }}
          delete-branch: true

